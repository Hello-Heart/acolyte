(function(e){var t=e("#add-rule"),n=function(t){return e.trim(t.val())==""?false:true},r=function(t){return e.isNumeric(t.val())},i=function(){t.tooltip("destroy").tooltip({title:"Define a case by adding a rule",placement:"bottom"})},s=function(e,t){return function(){return{name:e.val(),_type:t.val()}}},o=e("#case-rules .list-group"),u=e("#route-editor"),a=e("#rule-form"),f=e("#result-form"),l=e("#param-pattern .badge"),c=e("#param-pattern .position"),h=e("#param-pattern ol"),p=e("#param-type"),d=e("#ruleKind"),v=e("#add-param"),m=e("#ruleExp").on("keyup change",function(){var e=m.val();if(e==""){m.addClass("has-error");return v.attr("disabled","disabled")}try{new RegExp(e);m.removeClass("has-error");v.removeAttr("disabled")}catch(t){m.addClass("has-error");v.attr("disabled","disabled")}}),g=e("#raise-error"),y=e("#result-error").click(function(){g.trigger("click");return false}),b=e("#result-data"),w=e("#test-routes").click(function(){var t=e('<form action="run.html" method="POST"></form>'),n=new Array;e(".list-group-item",o).each(function(t,r){n.push(e.parseJSON(e(r).data("json")))});t.append('<textarea name="json">'+JSON.stringify(n)+"</textarea>").css({visibility:"hidden"}).appendTo("body").trigger("submit");return false}),E=function(t){e(".operations",t).html('<i class="fa fa-minus-circle"></i>')},S=function(t){e("#case-result .list-group-item:nth("+t.index()+")").remove();t.remove();if(e(".list-group-item",o).length==0){w.attr("disabled","disabled").text("No route to prepare connection")}},x=function(t){var n=e("#case-result .list-group-item:nth("+t.index()+")"),r=n.prev(),i=t.prev();n.removeClass("hover").detach().insertBefore(r);e(".operations",t).html(" ");t.detach().insertBefore(i)},T=function(t){var n=e("#case-result .list-group-item:nth("+t.index()+")"),r=n.next(),i=t.next();n.removeClass("hover").detach().insertAfter(r);e(".operations",t).html(" ");t.detach().insertAfter(i)},N=function(t){var n=e('<i class="fa fa-long-arrow-up"></i>'),r=e('<i class="fa fa-long-arrow-down"></i>'),i=t.index();if(i==0)n.addClass("text-muted");else n.css({cursor:"n-resize"}).click(function(){x(t);return false});if(t.next().length==0)r.addClass("text-muted");else r.css({cursor:"s-resize"}).click(function(){T(t);return false});e(".operations",t).empty().append(n).append(r)},C=E,k=S,L=e("#move-rule"),A=function(t,n,r){var i=null,s=null;if(r["error"]){i='Error = <tt class="text-info">'+r.error+"</tt>"}else if(t=="update"){var u=r["updateCount"];i="Updated row"+(u>1?"s":"")+': <tt class="text-info">'+u+"</tt>"}else{var a="",f="",l;for(l=0;l<r.schema.length;l++){var c=r.schema[l]._type,h=r.schema[l].name;if(a!="")a+=", ";a+=c;f+="<td>"+h+"</td>"}i="Result set = "+r.rows.length+" x ("+a+")";s={placement:"top",trigger:"hover",html:true,content:'<table class="table table-striped"><thead><tr>'+f+"</tr></thead><tbody>"+e("#result-data tbody").html()+"</tbody></table>"}}var p=e('<a class="list-group-item" href="#">'+t+' = <tt class="text-info">'+n.expression+"</tt></a>").appendTo(o),d=e('<span class="operations"> </span>').prependTo(p);p.hover(function(){e("#case-result .list-group-item:nth("+p.index()+")").addClass("hover");C(p)},function(){e("#case-result .list-group-item:nth("+p.index()+")").removeClass("hover");d.html(" ")}).click(function(){k(p);return false}).data("json",JSON.stringify({_type:t,pattern:n,result:r}));var v=e('<i class="fa fa-table"></i>'),m=e('<li class="list-group-item">'+i+"</li>").appendTo("#case-result .list-group").prepend(v).hover(function(){v.css({visibility:"visible"})},function(){v.css({visibility:"hidden"})});if(s)m.popover(s);w.removeAttr("disabled").html('Run defined connection <i class="fa fa-chevron-right"></i>')},O=e("#route-editor .ac-apply").click(function(){var t,n=[],r=null,i=d.val();e("#param-pattern li").each(function(t,r){var i=e(r);n.push({_type:i.data("type"),value:i.data("value")})});t={expression:m.val(),parameters:n};if(g.is(":checked")){r={error:y.val()}}else if(i=="update"){r={updateCount:parseInt(e("#update-count").val())}}else{r={schema:[],rows:[]};e("#result-data .res-row:first td:not(:first)").each(function(t,n){var i=e(n),s=i.data("type"),o=i.data("name");r.schema.push({_type:s,name:o})});e("#result-data .res-row").each(function(t,n){var i=[];e("td:not(:first)",n).each(function(t,n){i.push(e(n).text())});r.rows.push(i)});e("#result-data tbody > tr:not(.res-row)").remove();e("#result-data .res-row").each(function(t,n){e("td:first",n).remove()})}e("#case-rules .text-muted").remove();e("#case-result .text-muted").remove();u.modal("hide");A(i,t,r)}),M=function(){var t=e('<input type="number" min="0" id="update-count" class="form-control" />'),n=function(){if(r(t))O.removeAttr("disabled");else O.attr("disabled","disabled")},i=e('<input type="radio" name="result-type" id="update-success"/>').on("keyup change",function(){var r=e(this);if(r.is(":checked")){t.removeAttr("disabled");n()}else t.attr("disabled","disabled")});e('<div class="input-group"></div>').append(t.on("keyup change",n).click(function(){i.trigger("click")})).prepend(e('<label class="input-group-addon"> Update count</label>').prepend(i)).tooltip({title:"Execution is successful, then count of updated rows is returned."}).appendTo(b.empty())},_=function(){var t=e('<input type="radio" name="result-type" id="query-success"/>'),i=e('<select id="row-size" class="form-control"><option value="1">1 column</option><option value="2">2 columns</option><option value="3">3 columns</option></select>').tooltip({title:"How many columns there will be on each result row?",trigger:"focus",delay:{hide:3e3}}).click(function(){t.trigger("click")}),o=e("<div></div>").appendTo(b.empty()).css({display:"none"}),u=function(){var t,u=[],a=parseInt(i.val()),f=a==3?"col-md-4":a==2?"col-md-6":"col-md-12",l=e('<button class="btn btn-default">Create rows...</button>'),c=function(e){return function(){return n(e)}},h=function(e){return function(){return r(e)}};o.empty().css({display:"block"});for(t=1;t<=a;t++){var p=e('<input type="text" class="form-control col-md-6 col-sm-12" id="col'+t+'name" value="Column #'+t+'" />').on("keyup change",function(){var t=e(this);if(!n(t)){t.addClass("has-error");l.attr("disabled","disabled");return false}else{t.removeClass("has-error");l.removeAttr("disabled");return true}}).tooltip({title:"Name of column #"+t}),d=e('<select id="col'+t+'type" class="form-control col-md-6 col-sm-12"></select>').tooltip({title:"Type of column #"+t});e.each(P,function(e,t){d.append('<option value="'+e+'">'+t+"</option>")});u.push(s(p,d));e('<div class="row col-def"></div>').append(p).append(d).appendTo(o)}o.append(l.click(function(){var n=e('<table class="table table-striped"></table>'),i=e("<tr><td></td></tr>").appendTo(e("<thead></thead>").appendTo(n)),s=e('<tr><td class="text-center"><i class="fa fa-pencil text-muted"></i></td></tr>').appendTo(e("<tbody></tbody>").appendTo(n)),f=e('<button class="btn btn-default" disabled="disabled">Add this row <i class="fa fa-hand-o-up"></i></button>'),l=function(t){return function(){var n=e(this);if(!t(n))n.addClass("has-error");else n.removeClass("has-error")}},p=[],d=function(){var e=true;for(t=0;e&&t<p.length;t++)e=p[t]();if(e)f.removeAttr("disabled");else f.attr("disabled","disabled")},v=[],m=function(e,t,n){return function(){var r=n.val();n.val(null);return{name:e,_type:t,val:r}}},g=function(){e(this).remove();if(e(".res-row",n).length==0){O.attr("disabled","disabled")}},y=function(){var n=e('<tr class="res-row"></tr>'),r=e('<i class="fa fa-minus-circle"></i>').appendTo(e("<td></td>").appendTo(n)).css({display:"none"});for(t=0;t<v.length;t++){var i=v[t]();e("<td>"+i.val+"</td>").appendTo(n).data("type",i._type).data("name",i.name)}n.insertBefore(s).hover(function(){r.css({display:"inline"})},function(){r.css({display:"none"})}).click(g);O.removeAttr("disabled");return false};for(t=1;t<=a;t++){var b=u[t-1](),w=b.name,E=b._type,S=e('<input type="text" class="form-control" />');i.append('<td class="text-center">'+w+"</td>");S.appendTo(e("<td></td>").appendTo(s));if(E=="date"){p.push(c(S));S.attr("readonly","readonly").datepicker({format:"yyyy-mm-dd"}).on("changeDate",d).tooltip({title:"Date for "+w})}else if(E=="float"){p.push(h(S));S.on("keyup change",l(r)).on("keyup change",d).tooltip({title:"Number for "+w})}else{S.on("keyup change",d).tooltip({title:"Text for "+w})}v.push(m(w,E,S))}f.appendTo(o.empty()).click(y);o.prepend(n);return false}))},a=function(){g.one("click",function(){i.attr("disabled","disabled");o.empty()});O.attr("disabled","disabled");i.removeAttr("disabled");u()};e('<div class="input-group"></div>').append(i.change(u)).prepend(e('<label class="input-group-addon"> Result set</label>').tooltip({title:"Execution is successful, then some rows are returned."}).prepend(t.click(a))).prependTo(b.append('<p class="text-muted">Column number is limited on purpose for this tour.</p>'));e('<p class="text-muted">Acolyte <a href="http://acolyte.eu.org/studio.html" rel="external me" title="Acolyte Studio">Studio</a> allows to re-use data from existing database.</p>').prependTo(b)},D=e("#route-editor .ac-next").click(function(){if(d.val()=="update")M();else _();var t=e(this);a.fadeOut(500,function(){f.fadeIn(500,function(){t.css({display:"none"});O.css({display:"inline"})})})}),P={string:"Text","float":"Number",date:"Date"},H=function(){var t=parseInt(l.text());e(this).remove();if(t==1)v.attr("disabled","disabled");c.text(t);l.text(t-1)},B=function(t){return function(){var n=e(this);if(!t(n)){n.addClass("has-error");v.attr("disabled","disabled")}else{n.removeClass("has-error");v.removeAttr("disabled")}}},j=B(n),F=B(r),I={title:"Expected value parameter",trigger:"focus"},q=function(){var t=e('<input type="text" class="form-control" id="param-value" />').tooltip(I).on("keyup change",j);e("#param-value").replaceWith(t)};v.click(function(){var t=parseInt(c.text()),n=p.val(),r=e("#param-value").val(),i=e('<i class="fa fa-minus-circle"></i>');e("<li>"+P[n]+' = <tt class="text-info">'+r+"</tt></li>").prepend(i).data("type",n).data("value",r).appendTo(h).hover(function(){i.css({visibility:"visible"})},function(){i.css({visibility:"hidden"})}).click(H);v.removeAttr("disabled");c.text(t+1);l.text(t);return false});g.click(function(){if(n(y))O.removeAttr("disabled");else O.attr("disabled","disabled")});y.on("keyup change",function(){if(g.is(":checked")&&n(e(this))){O.removeAttr("disabled")}else O.attr("disabled","disabled")});e.each(P,function(e,t){p.append('<option value="'+e+'">'+t+"</option>")});t.one("mouseover",i).tooltip({title:"First, add (at least) a rule to define which access case(s) you want to handle.",placement:"bottom"}).on("hidden.bs.tooltip",i).one("shown.bs.tooltip",function(){setTimeout(i,15e3)}).tooltip("show").click(function(){a.trigger("reset").css({display:"block"});f.trigger("reset").css({display:"none"});D.css({display:"inline"});O.css({display:"none"});b.empty();h.empty();c.text(1);l.text(0);u.modal();return false});a.on("reset",q);p.change(function(){var t=e(this).val();v.attr("disabled","disabled");if(t=="date"){e("#param-value").replaceWith(e('<input type="text" class="form-control ac-date" id="param-value" readonly="readonly" />').tooltip(I).datepicker({format:"yyyy-mm-dd"}).one("changeDate",function(){v.removeAttr("disabled")}))}else if(t=="float"){e("#param-value").replaceWith(e('<input type="text" class="form-control" id="param-value" />').tooltip(I).on("keyup change",F))}else q()});e("#raise-error").change(function(){var t=e(this);if(t.is(":checked"))y.removeAttr("readonly");else y.attr("readonly","readonly")});L.click(function(){if(!L.hasClass("active")){C=N;k=function(){}}else{C=E;k=S}});e(".has-tooltip").one("mouseover",i).tooltip();e._loadRoutes=function(t){if(t.length>0){e("#case-rules .text-muted").remove();e("#case-result .text-muted").remove()}var n;for(n=0;n<t.length;n++){A(t[n]._type,t[n].pattern,t[n].result)}}})(jQuery)
